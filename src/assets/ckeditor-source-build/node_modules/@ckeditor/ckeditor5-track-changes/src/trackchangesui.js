/*
 *             Copyright (c) 2016 - 2022, CKSource Holding sp. z o.o. All rights reserved.
 *
 *
 *
 *
 *          +---------------------------------------------------------------------------------+
 *          |                                                                                 |
 *          |                                 Hello stranger!                                 |
 *          |                                                                                 |
 *          |                                                                                 |
 *          |   What you're currently looking at is the source code of a legally protected,   |
 *          |    proprietary software. Any attempts to deobfuscate / disassemble this code    |
 *          |               are forbidden and will result in legal consequences.              |
 *          |                                                                                 |
 *          |                                                                                 |
 *          +---------------------------------------------------------------------------------+
 *
 *
 *
 *
 */
import{Plugin as _0x3a01cf}from'ckeditor5/src/core';import _0x202257 from'./trackchangesediting';import _0x173eac from'@ckeditor/ckeditor5-comments/src/comments/commentsrepository';import Ct from'./ui/suggestioncontroller';import Tt from'./ui/view/suggestionthreadview';import _0xdd9095 from'@ckeditor/ckeditor5-collaboration-core/src/users';import xt from'@ckeditor/ckeditor5-comments/src/annotations/editorannotations';import{Collection as Et}from'ckeditor5/src/utils';import{Model as At,SplitButtonView as Nt,createDropdown as Ut,addListToDropdown as Wt}from'ckeditor5/src/ui';import _t from'@ckeditor/ckeditor5-comments/src/utils/getdatetimeformatter';import Ot from'@ckeditor/ckeditor5-comments/src/utils/getmarkerdomelement';import Gt from'../theme/icons/track-changes.svg';import{debounce as Mt}from'lodash-es';import Pt from'@ckeditor/ckeditor5-comments/src/annotations/view/annotationview';import Vt from'@ckeditor/ckeditor5-comments/src/annotations/annotation';import qt from'@ckeditor/ckeditor5-comments/src/annotations/annotations';export default class f extends _0x3a01cf{static get['requires'](){return[qt,xt,_0x202257,_0x173eac,_0xdd9095];}static get['pluginName'](){return'TrackChangesUI';}constructor(_0x7a1337){super(_0x7a1337),this['_suggestionToController']=new Map(),this['_viewToController']=new Map(),this['_debouncedHandlers']=new Map();const _0x4096df=this['editor']['config'];_0x4096df['define']('trackChanges.SuggestionThreadView',Tt),_0x4096df['define']('trackChanges.disableComments',!0x1),this['_disableComments']=_0x4096df['get']('trackChanges.disableComments');}['init'](){const _0x14b82b=this['editor'],_0x28231b=_0x14b82b['plugins']['get'](_0x202257),_0xf842a5=_0x14b82b['plugins']['get'](qt),_0x5c3fa0=_0x14b82b['plugins']['get'](xt),_0x2de147=_0x14b82b['plugins']['get'](_0x173eac);_0x14b82b['ui']['componentFactory']['add']('trackChanges',_0x637294=>this['_createUIButton'](_0x637294)),_0x5c3fa0['addSourceCollector'](()=>{const _0x1a98ff=[];for(const [_0x2335dc,_0x5aa22a]of Array['from'](this['_suggestionToController'])){const _0x1d62e2=_0x2335dc['getAllAdjacentSuggestions'](),_0x45ace0=[];for(const _0x3f3748 of _0x1d62e2){if(!_0x3f3748['isInContent'])continue;if(_0x3f3748['isMultiRange']){_0x45ace0['push'](..._0x3f3748['getRanges']());continue;}const _0x23f9c0=_0x3f3748['getFirstRange']();if(_0x45ace0['length']>0x0){const _0x5e0924=_0x45ace0[0x0]['getJoined'](_0x23f9c0);if(_0x5e0924){_0x45ace0[0x0]=_0x5e0924;continue;}}_0x45ace0['push'](_0x23f9c0);}_0x1a98ff['push']([_0x5aa22a['view'],_0x45ace0]);}return _0x1a98ff;}),this['listenTo'](_0x28231b,'suggestionLoaded',(_0x22ddd5,_0x2de540)=>{let _0x197cfb=!0x1;const _0x184916=Mt(_0x56402c=>{_0x197cfb||_0x56402c?_0x197cfb&&_0x56402c&&(this['_destroyController'](_0x2de540),_0x5c3fa0['refreshSelectedViews'](),_0x197cfb=!0x1):(this['_initializeController'](_0x2de540),_0x5c3fa0['refreshSelectedViews'](),_0x197cfb=!0x0);},0xa);this['_debouncedHandlers']['set'](_0x2de540,_0x184916),this['listenTo'](_0x2de540,'change:previous',(_0xe1280f,_0xa70a3f,_0xd07789,_0x16220e)=>{_0x2de540['isInContent']&&(null==_0xd07789?(this['_updateController'](_0x16220e['head']),_0x184916(!0x1)):(this['_updateController'](_0xd07789['head']),_0x184916(!0x0)));}),null===_0x2de540['previous']?_0x184916(!0x1):this['_updateController'](_0x2de540['head']);}),this['listenTo'](_0x28231b,'suggestionUnloaded',(_0xb67bf4,_0x1bebb7,_0x491275)=>{this['stopListening'](_0x1bebb7,'change:previous'),this['_debouncedHandlers']['get'](_0x1bebb7)['cancel'](),this['_debouncedHandlers']['delete'](_0x1bebb7);const _0x53fb7c=_0x491275?_0x491275['head']:_0x1bebb7,_0x26c73f=this['_suggestionToController']['get'](_0x53fb7c);null!==_0x491275&&this['_updateController'](_0x53fb7c),null===_0x491275&&_0x26c73f&&this['_destroyController'](_0x1bebb7);}),this['listenTo'](_0x28231b,'suggestionChanged',(_0x3b30cd,_0x54ce96)=>{this['_updateController'](_0x54ce96);}),this['listenTo'](_0xf842a5,'change:activeAnnotations',(_0x38bcb6,_0x1ea370,_0x3048f6)=>{const _0x37fba8=Array['from'](_0x3048f6,_0x588ad9=>_0x588ad9['innerView'])['filter'](_0x20a78e=>this['_viewToController']['has'](_0x20a78e)),_0x468aac=[];for(const _0x359e7a of _0x37fba8){const _0x3042ec=this['_viewToController']['get'](_0x359e7a)['model']['getAllAdjacentSuggestions']();_0x468aac['push'](..._0x3042ec['reduce']((_0x3d2648,_0x4e7977)=>[..._0x3d2648,..._0x4e7977['getMarkerNames']()],[]));}_0x28231b['activeMarkers']=_0x468aac;}),this['listenTo'](_0x2de147,'addComment',(_0x3c1b2f,{threadId:_0x55240e,isFromAdapter:_0x2724d7})=>{if(_0x2724d7||!_0x28231b['hasSuggestion'](_0x55240e))return;const _0x1829b0=_0x28231b['getSuggestion'](_0x55240e);this['_suggestionToController']['get'](_0x1829b0)['view']['focus']();},{'priority':'lowest'});}['_createUIButton'](_0x1f0171){const _0x13bed8=Ut(_0x1f0171,Nt),_0x1c0b7f=this['editor']['commands']['get']('trackChanges'),{t:t}=this['editor'];_0x13bed8['buttonView']['set']({'tooltip':t('Track\x20changes'),'label':t('Track\x20changes'),'icon':Gt}),_0x13bed8['buttonView']['bind']('isOn')['to'](_0x1c0b7f,'value'),_0x13bed8['buttonView']['on']('execute',()=>_0x1c0b7f['execute']());const _0x9f77bd=new Et(),_0x39c2fa=[{'type':'switchbutton','model':{'withText':!0x0,'label':t('Track\x20changes'),'commandName':'trackChanges'}},{'type':'separator'},{'type':'button','model':{'withText':!0x0,'label':t('Accept\x20all\x20suggestions'),'commandName':'acceptAllSuggestions'}},{'type':'button','model':{'withText':!0x0,'label':t('Accept\x20all\x20selected\x20suggestions'),'commandName':'acceptSelectedSuggestions'}},{'type':'button','model':{'withText':!0x0,'label':t('Discard\x20all\x20suggestions'),'commandName':'discardAllSuggestions'}},{'type':'button','model':{'withText':!0x0,'label':t('Discard\x20all\x20selected\x20suggestions'),'commandName':'discardSelectedSuggestions'}}];for(const _0x10c7ba of _0x39c2fa){const _0x56e9c7={'type':_0x10c7ba['type']};if(_0x10c7ba['model']){const _0x231dd8=new At(_0x10c7ba['model']),_0x1745a3=this['editor']['commands']['get'](_0x231dd8['commandName']);_0x231dd8['bind']('isOn','isEnabled')['to'](_0x1745a3,'value','isEnabled'),_0x56e9c7['model']=_0x231dd8;}_0x9f77bd['add'](_0x56e9c7);}Wt(_0x13bed8,_0x9f77bd);const _0x5cfc9a=_0x39c2fa['filter'](_0x3a0d91=>null!=_0x3a0d91['model'])['map'](_0x23161a=>this['editor']['commands']['get'](_0x23161a['model']['commandName']));return _0x13bed8['buttonView']['actionView']['unbind']('isEnabled'),_0x13bed8['buttonView']['arrowView']['unbind']('isEnabled'),_0x13bed8['buttonView']['actionView']['bind']('isEnabled')['to'](_0x1c0b7f,'isEnabled'),_0x13bed8['buttonView']['arrowView']['bind']('isEnabled')['toMany'](_0x5cfc9a,'isEnabled',(..._0x34ee32)=>_0x34ee32['some'](_0x5cb8b8=>_0x5cb8b8)),_0x13bed8['on']('execute',_0x3e7f4b=>this['editor']['execute'](_0x3e7f4b['source']['commandName'])),_0x13bed8;}['_initializeController'](_0x2ed806){const _0x25f2c2=this['editor'],_0x107698=_0x25f2c2['config'],_0x3f2783=_0x25f2c2['plugins']['get'](qt),_0x10d8f9=_0x2ed806['getAllAdjacentSuggestions']()['filter'](_0x58f54d=>_0x58f54d['isInContent']),_0x4abaf5=_0x25f2c2['plugins']['get']('Users')['me'],_0x50883d=_0x25f2c2['commands']['get']('acceptSuggestion'),_0x42060b=_0x25f2c2['commands']['get']('discardSuggestion'),_0x3e5e59=new(0x0,(_0x107698['get']('trackChanges'))['SuggestionThreadView'])(_0x25f2c2['locale'],_0x2ed806,_0x4abaf5,{'disableComments':this['_disableComments'],'editorConfig':_0x107698['get']('comments.editorConfig'),'maxCommentsWhenCollapsed':_0x107698['get']('comments.maxCommentsWhenCollapsed'),'maxThreadTotalWeight':_0x107698['get']('comments.maxThreadTotalWeight'),'maxCommentCharsWhenCollapsed':_0x107698['get']('comments.maxCommentCharsWhenCollapsed'),'formatDateTime':_t(_0x107698['get']('locale')),'CommentView':_0x107698['get']('comments')['CommentView']}),_0x44f559=new Ct(_0x2ed806,_0x3e5e59,_0x50883d,_0x42060b);_0x3e5e59['descriptionParts']=_0x25f2c2['plugins']['get']('TrackChangesEditing')['_descriptionFactory']['getDescriptions'](_0x10d8f9),this['_suggestionToController']['set'](_0x2ed806,_0x44f559),this['_viewToController']['set'](_0x3e5e59,_0x44f559);const _0x314a75=new Pt(this['editor']['locale'],_0x3e5e59);_0x314a75['bind']('isDirty')['to'](_0x3e5e59,'isDirty'),_0x314a75['bind']('length')['to'](_0x3e5e59),_0x314a75['bind']('type')['to'](_0x3e5e59,'type',_0x320c73=>'suggestion-'+_0x320c73);const _0x51dfe1=new Vt({'view':_0x314a75,'target':()=>{const _0x42faa8=_0x10d8f9[0x0]['getFirstMarker']();if(!_0x42faa8)return null;const _0x24034b=_0x42faa8['getRange']()['getContainedElement']();return _0x24034b&&!_0x25f2c2['editing']['mapper']['toViewElement'](_0x24034b)?null:Ot(_0x25f2c2['editing'],_0x42faa8)||null;},'type':()=>'suggestion-'+_0x44f559['view']['type']});_0x3f2783['add'](_0x51dfe1);const _0x2d9605=_0x25f2c2['plugins']['get']('PendingActions');let _0x18c16a;_0x3e5e59['on']('change:isDirty',(_0x2c6be1,_0x351ef0,_0x4003ea)=>{if(_0x4003ea){const t=this['editor']['locale']['t'];_0x18c16a=_0x2d9605['add'](t({'string':'Unsaved\x20change\x20in\x20suggestion.','id':'PENDING_ACTION_SUGGESTION'}));}else _0x2d9605['remove'](_0x18c16a),_0x18c16a=null;});}['_destroyController'](_0x10f2e3){const _0x317147=this['editor']['plugins']['get']('Annotations'),_0x696471=this['_suggestionToController']['get'](_0x10f2e3),_0x35f333=_0x696471['view'],_0x3e2e9d=_0x317147['getByInnerView'](_0x35f333);_0x3e2e9d&&_0x317147['remove'](_0x3e2e9d),this['_suggestionToController']['delete'](_0x10f2e3),this['_viewToController']['delete'](_0x35f333),_0x696471['destroy'](),_0x35f333['destroy']();}['_updateController'](_0x1e9026){if(!_0x1e9026['isInContent']||!this['_suggestionToController']['has'](_0x1e9026))return;const _0x45de29=this['editor']['plugins']['get']('TrackChangesEditing'),_0x57ee97=this['_suggestionToController']['get'](_0x1e9026),_0x13e839=_0x1e9026['getAllAdjacentSuggestions']();_0x57ee97['view']['descriptionParts']=_0x45de29['_descriptionFactory']['getDescriptions'](_0x13e839);}['destroy'](){super['destroy']();for(const _0x209643 of this['_suggestionToController']['keys']())this['_destroyController'](_0x209643);for(const _0x2e800d of this['_debouncedHandlers']['values']())_0x2e800d['cancel']();this['_debouncedHandlers']['clear']();}}