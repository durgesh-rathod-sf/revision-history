/*
 *             Copyright (c) 2016 - 2022, CKSource Holding sp. z o.o. All rights reserved.
 *
 *
 *
 *
 *          +---------------------------------------------------------------------------------+
 *          |                                                                                 |
 *          |                                 Hello stranger!                                 |
 *          |                                                                                 |
 *          |                                                                                 |
 *          |   What you're currently looking at is the source code of a legally protected,   |
 *          |    proprietary software. Any attempts to deobfuscate / disassemble this code    |
 *          |               are forbidden and will result in legal consequences.              |
 *          |                                                                                 |
 *          |                                                                                 |
 *          +---------------------------------------------------------------------------------+
 *
 *
 *
 *
 */
import{Plugin as _0x50e1dc}from'ckeditor5/src/core';import _0x2bee1c from'./revisiontracker';import _0x57135f from'./ui/revisionhistory/revisionhistoryui';import _0x1b09d1 from'./revisionviewer';import _0x5a15e5 from'./ui/revisionviewer/revisionviewerui';import _0x2be2a8 from'./ui/revisionssidebar/revisionssidebar';import _0x1016a9 from'@ckeditor/ckeditor5-editor-classic/src/classiceditor';import{CKEditorError as _0x56ddef,uid as _0x34d8ec}from'ckeditor5/src/utils';const m=['RevisionTracker','RevisionHistoryUI','WebSocketGateway','CommentsRepository','TrackChangesEditing','RestrictedEditingMode','Autosave'];export default class p extends _0x50e1dc{static get['pluginName'](){return'RevisionHistory';}static get['requires'](){return[_0x2bee1c,_0x57135f];}constructor(..._0x4e8356){if(super(..._0x4e8356),!this['editor']['config']['get']('revisionHistory'))throw new _0x56ddef('revision-history-missing-configuration',this);this['_viewerEditor']=null,this['editor']['config']['define']('revisionHistory.showRevisionViewerCallback',_0x106648=>this['_showRevisionViewer'](_0x106648)),this['editor']['config']['define']('revisionHistory.closeRevisionViewerCallback',_0xf6f3f8=>this['_closeRevisionViewer'](_0xf6f3f8)),this['editor']['config']['define']('revisionHistory.restoreRevisionCallback',_0xa0105e=>this['_restoreRevision'](_0xa0105e)),this['_enhanceShowRevisionViewerCallback'](),this['_enhanceCloseRevisionViewerCallback']();}set['adapter'](_0x4dfa2f){this['editor']['plugins']['get']('RevisionTracker')['adapter']=_0x4dfa2f;}get['adapter'](){return this['editor']['plugins']['get']('RevisionTracker')['adapter'];}['addRevisionData'](..._0x474d6f){return this['editor']['plugins']['get']('RevisionTracker')['addRevisionData'](..._0x474d6f);}['getRevision'](..._0x349c5e){return this['editor']['plugins']['get']('RevisionsRepository')['getRevision'](..._0x349c5e);}['getRevisions'](..._0x288010){return this['editor']['plugins']['get']('RevisionsRepository')['getRevisions'](..._0x288010);}['_getRevisionViewerEditorConfig'](){const _0x4d633f={},_0x18a94f=this['editor'],_0x5cd830=_0x18a94f['plugins']['get']('RevisionTracker'),_0x2fac93=_0x18a94f['plugins']['get']('Users')['users'];for(const _0x1fd68e of _0x18a94f['config']['names']())_0x4d633f[_0x1fd68e]=_0x18a94f['config']['get'](_0x1fd68e);delete _0x4d633f['context'],_0x4d633f['initialData']='',_0x4d633f['toolbar']=['exitToEditing','restoreRevision','changesNavigation'];const _0x5644f5=this['editor']['constructor']['builtinPlugins']||[],_0x3d6139=_0x4d633f['extraPlugins']||[];delete _0x4d633f['extraPlugins'];const _0x4f6af3=_0x5644f5['concat'](_0x4d633f['plugins'])['concat'](_0x3d6139)['map'](_0x3986c4=>'string'==typeof _0x3986c4?_0x5644f5['find'](_0x3f63f8=>_0x3f63f8['pluginName']==_0x3986c4):_0x3986c4);return _0x4d633f['plugins']=Array['from'](new Set(_0x4f6af3))['filter'](_0x57dffa=>g(_0x57dffa,_0x18a94f['plugins'],[])),(_0x4d633f['plugins']['push'](_0x1b09d1,_0x5a15e5,class extends _0x50e1dc{static get['requires'](){return[_0x1b09d1,'Users'];}['init'](){const _0x2ef17e=this['editor']['plugins']['get']('Users');for(const _0x6fc38 of _0x2fac93)_0x6fc38['isAnonymous']||_0x2ef17e['getUser'](_0x6fc38['id'])||_0x2ef17e['addUser'](_0x6fc38);const _0x52a9e6=_0x5cd830['repository']['getRevisions']();let _0xde7fb2=null;const _0x54121d=this['editor']['plugins']['get']('RevisionViewer');_0x54121d['adapter']=_0x5cd830['adapter'],_0x54121d['bind']('isEnabled')['to'](_0x5cd830),this['editor']['commands']['get']('restoreRevision')['bind']('isEnabled')['to'](_0x18a94f,'isReadOnly',_0x20a930=>!_0x20a930);for(const _0x4c7c0c of _0x52a9e6){const _0x8f18d7=null===_0x4c7c0c['creator'];if(_0x8f18d7&&_0x4c7c0c['toVersion']===_0x4c7c0c['fromVersion'])continue;const _0x5b4e99=_0x4c7c0c['toJSON']();_0x54121d['addRevisionData'](_0x5b4e99,(_0x2f7f26,_0x962746,_0x1ca981)=>{if(_0x8f18d7){if(_0xde7fb2)_0xde7fb2['_update'](_0x2f7f26,_0x962746);else{if(!_0x962746){const _0x33e5e5=_0x1ca981['toJSON']();_0x33e5e5['id']=_0x34d8ec(),_0x5cd830['saveRevision'](_0x33e5e5,_0x1ca981['toVersion'])['then'](_0x2d941f=>{_0xde7fb2=_0x2d941f;});}}}else _0x4c7c0c['_update'](_0x2f7f26,_0x962746);});}}},_0x2be2a8),_0x4d633f);}['_enhanceShowRevisionViewerCallback'](){const _0x2ee331=this['editor']['config']['get']('revisionHistory')['showRevisionViewerCallback'];this['editor']['config']['set']('revisionHistory.showRevisionViewerCallback',async()=>{this['editor']['isReadOnly']=!0x0;const _0x1cd8e7=this['editor']['plugins']['get']('RevisionTracker');this['editor']['plugins']['has']('Autosave')?await this['editor']['plugins']['get']('Autosave')['save']():await _0x1cd8e7['update'](),this['editor']['plugins']['has']('PaginationLookup')&&this['editor']['plugins']['get']('PaginationLookup')['_recalculatePageBreaks']();const _0x519b1e=this['_getRevisionViewerEditorConfig']();return _0x2ee331(_0x519b1e)['then'](_0x1268e6=>{this['_viewerEditor']=_0x1268e6,this['editor']['plugins']['has']('Annotations')&&this['editor']['plugins']['get']('Annotations')['refreshVisibility']();});});}['_enhanceCloseRevisionViewerCallback'](){const _0x5cc4a8=this['editor']['config']['get']('revisionHistory')['closeRevisionViewerCallback'];this['editor']['config']['set']('revisionHistory.closeRevisionViewerCallback',()=>(this['editor']['plugins']['has']('PaginationLookup')&&this['editor']['plugins']['get']('PaginationLookup')['_recalculatePageBreaks'](),_0x5cc4a8(this['_viewerEditor'])['then'](()=>{this['editor']['plugins']['has']('WebSocketGateway')?this['editor']['isReadOnly']='connected'!==this['editor']['plugins']['get']('WebSocketGateway')['state']:this['editor']['isReadOnly']=!0x1,this['_viewerEditor']=null,this['editor']['plugins']['has']('Annotations')&&(this['editor']['plugins']['get']('Annotations')['refreshVisibility'](),this['editor']['plugins']['get']('Annotations')['refreshPositioning']());})));}['_showRevisionViewer'](_0x1efede){const _0x48d049=this['editor']['config']['get']('revisionHistory.editorContainer'),_0x506ef7=this['editor']['config']['get']('revisionHistory.viewerContainer'),_0x39f5fe=this['editor']['config']['get']('revisionHistory.viewerEditorElement');return _0x1016a9['create'](_0x39f5fe,_0x1efede)['then'](_0x3ac28d=>(_0x506ef7['style']['display']='block',_0x48d049['style']['display']='none',_0x3ac28d));}['_closeRevisionViewer'](_0x1b198e){const _0x28c28d=this['editor']['config']['get']('revisionHistory.editorContainer');return this['editor']['config']['get']('revisionHistory.viewerContainer')['style']['display']='none',_0x28c28d['style']['display']='',_0x1b198e['destroy']();}async['_restoreRevision'](_0x4cd530){const _0xcba04d=this['editor'],t=_0xcba04d['t'],_0x3bcc27=this['_viewerEditor']['plugins']['get']('RevisionViewer'),_0x453c28=_0xcba04d['plugins']['get']('RevisionTracker'),_0xffebe6=_0x3bcc27['repository']['getRevision'](_0x4cd530);_0xcba04d['model']['change'](_0xac3c02=>{for(const _0xc3bcf2 of Array['from'](_0xcba04d['model']['markers']['getMarkersGroup']('restrictedEditingException')))_0xac3c02['removeMarker'](_0xc3bcf2);}),_0x3bcc27['isReady']=!0x1;const _0x5ee360=await _0x3bcc27['getRevisionData'](_0xffebe6);let _0x14d45f;_0xcba04d['data']['set'](_0x5ee360,{'suppressErrorInCollaboration':!0x0});const _0x56c10f=t('Restored');if(_0xffebe6['name'])_0x14d45f=-0x1==_0xffebe6['name']['indexOf'](_0x56c10f)?_0x56c10f+':\x20'+_0xffebe6['name']:_0xffebe6['name'];else _0x14d45f=_0x56c10f+':\x20'+(_0xffebe6['createdAt']['toLocaleDateString'](_0xcba04d['locale']['uiLanguage'],{'month':'long','day':'numeric'})+',\x20'+_0xffebe6['createdAt']['toLocaleTimeString'](_0xcba04d['locale']['uiLanguage'],{'hour':'numeric','minute':'numeric'}));return await _0x453c28['saveRevision']({'name':_0x14d45f}),_0x3bcc27['isReady']=!0x0,_0xcba04d['config']['get']('revisionHistory')['closeRevisionViewerCallback']();}}function g(_0x302101,_0x5a3e4a,_0x1eaa5c){const _0x2d906c='function'==typeof _0x302101?_0x302101['pluginName']||_0x302101['name']:_0x302101;if(_0x1eaa5c['includes'](_0x2d906c))return!0x0;if(_0x1eaa5c['push'](_0x2d906c),m['includes'](_0x2d906c))return!0x1;const _0x300e7b=(('function'==typeof _0x302101?_0x302101:_0x5a3e4a['has'](_0x2d906c)?_0x5a3e4a['get'](_0x2d906c):{})['requires']||[])['every'](_0x3746d4=>g(_0x3746d4,_0x5a3e4a,_0x1eaa5c));return _0x300e7b||m['push'](_0x2d906c),_0x300e7b;}